name: Deploy to GCP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to GCP instance
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            set -ex  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ

            # 1. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìœ¼ë©´ clone
            if [ ! -d "wecam-all-backend" ]; then
              git clone https://github.com/wecampus-platform/wecam-all-backend.git
            fi

            cd wecam-all-backend

            # 2. ë¡œì»¬ ë³€ê²½ ì´ˆê¸°í™” í›„ ìµœì‹  ì½”ë“œ pull
            git reset --hard HEAD
            git clean -fd
            git pull origin main

            # 3. .env íŒŒì¼ ë®ì–´ì“°ê¸°
            echo "${{ secrets.ENV_FILE }}" | sed 's/\\n/\n/g' > .env

            # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë³´ì¥
            chmod +x ./gradlew
            echo "!!!!!ë¹Œë“œ ì‹œì‘!!!!!!!"

            # 5. ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ìƒëµ)
            ./gradlew :wecam-backend:build -x test
          
            echo "â¹ Gradle build ì¢…ë£Œ ì½”ë“œ: $?"
            echo "!!!!!ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œì‘!!!!!!!"
            # 6. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            lsof -i:8080 || echo "âœ… 8080 í¬íŠ¸ ë¹„ì–´ ìˆìŒ"
            echo "ğŸ”´ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œë„..."
            pkill -f "java -jar" || true

            sleep 2

            # 6-1. 8080 í¬íŠ¸ ì ìœ  í™•ì¸ (ì—†ì–´ì•¼ ì •ìƒ ì¢…ë£Œëœ ê²ƒ)
            echo "ğŸ” 8080 í¬íŠ¸ ì ìœ  ì—¬ë¶€ í™•ì¸:"
            lsof -i:8080 || echo "âœ… 8080 í¬íŠ¸ ë¹„ì–´ ìˆìŒ"


            # 7. ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
            echo "ğŸŸ¢ ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì‹œì‘..."
            nohup java -jar wecam-backend/build/libs/wecam-backend-0.0.1-SNAPSHOT.jar > app.log 2>&1 & disown

            sleep 5

            # 7-1. í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ java í”„ë¡œì„¸ìŠ¤:"
            ps -ef | grep 'java -jar' | grep -v grep || echo "âŒ ì‹¤í–‰ëœ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"

            # 7-2. 8080 í¬íŠ¸ ìƒíƒœ ì¬í™•ì¸
            echo "ğŸ” í¬íŠ¸ 8080 ì¬í™•ì¸:"
            lsof -i:8080 || echo "âŒ í¬íŠ¸ ì—´ë ¤ ìˆì§€ ì•ŠìŒ"

          EOF

      - name: ë°°í¬ìš© remote ì„¤ì •
        run: git remote set-url origin https://x-access-token:${{ secrets.WORKFLOW_TOKEN }}@github.com/wecampus-platform/wecam-all-backend.git
